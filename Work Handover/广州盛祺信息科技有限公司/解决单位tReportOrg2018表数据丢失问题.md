### 解决单位tReportOrg2018表数据丢失问题：

#### 整体思路

从财厅系统获取单位树结构，分离出该单位的单位树结构，下发给该单位。

#### 操作步骤：

* 1，某系统（下称本地系统）发现某单位（下称本地单位）丢失tReportOrg2018表数据；

* 2，在本地系统获取本地单位PK、内码、名称信息（需要获取的是顶级单位，即导出报表时选择的那个单位节点），语句如下：

  ```sql
  --oracle和sqlserver数据库
    select t.pk             as 本地单位PK
        ,t.orgCode        本地单位内码
        ,t.orgDisplayCOde 本地单位外码
        ,t.orgName        本地单位名称
        ,t.*
    from tOrganization t
   where t.OrgName = '填写丢失数据的本地单位名称';
  
  ```

* 3，在财厅系统（下称财厅系统）按本地单位PK找到单位（下称财厅单位），获取本地单位的财厅单位内码，语句如下；

  ```sql
  --oracle和sqlserver数据库
    select t.pk             as 财厅单位PK
        ,t.orgCode        财厅单位内码
        ,t.orgDisplayCOde 财厅单位外码
        ,t.orgName        财厅单位名称
        ,t.*
    from tOrganization t
   where t.pk = '填写第2步查出的单位pk';
  ```

* 4，根据财厅单位内码在财厅系统查出财厅单位信息列表，语句如下：

  ```sql
  --oracle数据库
    select '填写第2步查出的本地单位内码' || substr(ORGCODE,length('填写第3步查出的财厅单位内码') + 1,length(orgcode)) as OrgCode
        ,ORGDISPLAYCODE,ORGORGANCODE,ORGNAME,ORGPROPERTY,ORGSYNOPSIS,ORGLINKER,ORGLINKTEL,ORGLINKADDRESS,ORGISCOLLECT,ORGUPCODE,ORGSERVERCODE,ORGDEPTH,ORGCHECKFLAG,LASTESTUPDATE,UPDATEPERSON,ORGADDRESS,ORGBASICTYPE,ORGMANAGELEVEL,ORGMANAGER,ORGFINANCEMANAGER,ORGENDCHECKFLAG,ORGASSETSMANAGER,ORGACCOUNTS,ORGISSETTRAINING,ORGHASAPPEND,ORGGLOBALCODE,ORGGLOBALPROPERTY,ORGPOSTALCODE,ORGISUPREPORT,ORGAPPROPRIATEFOUDS,ORGISEXPER,ORGISVO,ORGCOUNTV,ORGISHOUSE,ENTITYORGS,ORGLASTBALANCE,ORGTHISBALANCE,ORGBUDGETCODE,ORGTYPE,ORGISSGLEHAVE,ORGISSGLECHECK,ASSETMRGLEVELMD,ORGLEGALREPRESENT,ORGAPPROVEORG,ORGAPPROVENUM,ORGAPPROVEDATE,ORGFORM,ORGRECORDDATE,ORGRECORDNUM,ORGRECORDCAPITAL,ORGREGAUTHNUM,ORGSUBORDNUM,ORGFORMNUM,ORGLEVELNUM,ORGINDUSTRYNUM,ORGAREANUM,ORGMANAGERTEL,ORGFINANCEMANAGERTEL,ORGASSETSMANAGERTEL,ORGCLASS,ORGINNERCODE,ORGBUDGET,FWRIGHTSNO,TDRIGHTSNO,DATASOURCE,ISFINANINTER,ISORGAN,ISSHOWEXTRA,ISJOINTGB,ISNEEDAPPROVE,ISNEEDACCOUNT,ISCHANGEAPPROVE,ISCHANGEACCOUNT,APPENDFLODERNAME,PK,ORGANTYPE,ORGANLEVEL,HOUSELEADER,HOUSELEADERPHONE,HOUSECONTACT,HOUSECONTACTPHONE
    from tOrganization
   where orgCode like '填写第3步查出的财厅单位内码' || '%';
  
  
  --sqlserver数据库
    select '填写第2步查出的本地单位内码' + substring(ORGCODE,len('填写第3步查出的财厅单位内码') + 1,len(orgcode)) as OrgCode
        ,ORGDISPLAYCODE,ORGORGANCODE,ORGNAME,ORGPROPERTY,ORGSYNOPSIS,ORGLINKER,ORGLINKTEL,ORGLINKADDRESS,ORGISCOLLECT,ORGUPCODE,ORGSERVERCODE,ORGDEPTH,ORGCHECKFLAG,LASTESTUPDATE,UPDATEPERSON,ORGADDRESS,ORGBASICTYPE,ORGMANAGELEVEL,ORGMANAGER,ORGFINANCEMANAGER,ORGENDCHECKFLAG,ORGASSETSMANAGER,ORGACCOUNTS,ORGISSETTRAINING,ORGHASAPPEND,ORGGLOBALCODE,ORGGLOBALPROPERTY,ORGPOSTALCODE,ORGISUPREPORT,ORGAPPROPRIATEFOUDS,ORGISEXPER,ORGISVO,ORGCOUNTV,ORGISHOUSE,ENTITYORGS,ORGLASTBALANCE,ORGTHISBALANCE,ORGBUDGETCODE,ORGTYPE,ORGISSGLEHAVE,ORGISSGLECHECK,ASSETMRGLEVELMD,ORGLEGALREPRESENT,ORGAPPROVEORG,ORGAPPROVENUM,ORGAPPROVEDATE,ORGFORM,ORGRECORDDATE,ORGRECORDNUM,ORGRECORDCAPITAL,ORGREGAUTHNUM,ORGSUBORDNUM,ORGFORMNUM,ORGLEVELNUM,ORGINDUSTRYNUM,ORGAREANUM,ORGMANAGERTEL,ORGFINANCEMANAGERTEL,ORGASSETSMANAGERTEL,ORGCLASS,ORGINNERCODE,ORGBUDGET,FWRIGHTSNO,TDRIGHTSNO,DATASOURCE,ISFINANINTER,ISORGAN,ISSHOWEXTRA,ISJOINTGB,ISNEEDAPPROVE,ISNEEDACCOUNT,ISCHANGEAPPROVE,ISCHANGEACCOUNT,APPENDFLODERNAME,PK,ORGANTYPE,ORGANLEVEL,HOUSELEADER,HOUSELEADERPHONE,HOUSECONTACT,HOUSECONTACTPHONE
    from tOrganization
   where orgCode like '填写第3步查出的财厅单位内码' + '%';
  ```

* 5，导出第4步中查出的财厅单位信息；

* 6，将财厅单位信息恢复到本地系统：

  * 1.删除旧数据

  ```sql
	--删除旧数据  

	--oracle数据库解开下面语句，然后执行  
    delete from tReportOrg2018
   where exists (select 1
            from tReportOrg2018 t
           where t.pk = '填写第2步查出的本地单位PK'
             and tReportOrg2018.orgCode like t.orgCode || '%');
	
	--sqlserver数据库解开下面语句，然后执行  
    delete from tReportOrg2018
   where exists (select 1
            from tReportOrg2018 t
           where t.pk = '填写第2步查出的本地单位PK'
             and tReportOrg2018.orgCode like t.orgCode + '%');
  ```
  
  * 2.恢复数据，即将第5步导出的数据导入到本地系统。
